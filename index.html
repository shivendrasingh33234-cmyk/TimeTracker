<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#0f172a">
  <meta name="description" content="Track multiple activities simultaneously">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="TimeTracker">
  
  <title>Activity Time Tracker</title>
  
  <link rel="manifest" href="./manifest.json">
  <link rel="icon" type="image/png" sizes="192x192" href="./icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="./icon-512.png">
  <link rel="apple-touch-icon" href="./icon-192.png">
  
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio"></script>
  
  <style>
    * { -webkit-tap-highlight-color: transparent; }
    body { overscroll-behavior: none; }
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script>
    // Storage polyfill
    if (!window.storage) {
      window.storage = {
        get: async (key) => {
          const value = localStorage.getItem(key);
          return value ? { key, value, shared: false } : null;
        },
        set: async (key, value) => {
          localStorage.setItem(key, value);
          return { key, value, shared: false };
        },
        delete: async (key) => {
          localStorage.removeItem(key);
          return { key, deleted: true, shared: false };
        }
      };
    }

    // Simple app without React
    class TimeTracker {
      constructor() {
        this.activities = [];
        this.finishedActivities = [];
        this.intervals = {};
        this.view = 'tracker';
        this.reportView = 'table';
        this.showTotalTimer = true;
        
        this.loadData();
        this.render();
        this.startAutoSave();
      }

      async loadData() {
        try {
          const activitiesResult = await window.storage.get('activities');
          if (activitiesResult?.value) {
            this.activities = JSON.parse(activitiesResult.value);
          }
        } catch (e) {}
        
        try {
          const finishedResult = await window.storage.get('finishedActivities');
          if (finishedResult?.value) {
            this.finishedActivities = JSON.parse(finishedResult.value);
          }
        } catch (e) {}
        
        this.render();
        this.startTimers();
      }

      async saveData() {
        try {
          await window.storage.set('activities', JSON.stringify(this.activities));
          await window.storage.set('finishedActivities', JSON.stringify(this.finishedActivities));
        } catch (e) {
          console.error('Save failed:', e);
        }
      }

      startAutoSave() {
        setInterval(() => this.saveData(), 5000);
      }

      startTimers() {
        this.activities.forEach(activity => {
          if (activity.isRunning) {
            this.intervals[activity.id] = setInterval(() => {
              activity.elapsed++;
              this.render();
            }, 1000);
          }
        });
      }

      addActivity(name) {
        if (!name.trim()) return;
        
        const newActivity = {
          id: Date.now(),
          name: name.trim(),
          elapsed: 0,
          isRunning: false,
          startTime: null
        };
        
        this.activities.push(newActivity);
        this.saveData();
        this.render();
      }

      toggleActivity(id) {
        const activity = this.activities.find(a => a.id === id);
        if (!activity) return;

        if (activity.isRunning) {
          clearInterval(this.intervals[id]);
          delete this.intervals[id];
          activity.isRunning = false;
        } else {
          activity.isRunning = true;
          activity.startTime = activity.startTime || new Date().toISOString();
          this.intervals[id] = setInterval(() => {
            activity.elapsed++;
            this.render();
          }, 1000);
        }
        
        this.saveData();
        this.render();
      }

      finishActivity(id) {
        const activity = this.activities.find(a => a.id === id);
        if (!activity) return;

        if (this.intervals[id]) {
          clearInterval(this.intervals[id]);
          delete this.intervals[id];
        }

        activity.isRunning = false;
        activity.endTime = new Date().toISOString();
        activity.finishedAt = new Date().toISOString();

        this.finishedActivities.unshift(activity);
        this.activities = this.activities.filter(a => a.id !== id);
        
        this.saveData();
        this.render();
      }

      deleteActivity(id) {
        if (this.intervals[id]) {
          clearInterval(this.intervals[id]);
          delete this.intervals[id];
        }
        this.activities = this.activities.filter(a => a.id !== id);
        this.saveData();
        this.render();
      }

      deleteFinished(id) {
        this.finishedActivities = this.finishedActivities.filter(a => a.id !== id);
        this.saveData();
        this.render();
      }

      resetAll() {
        if (!confirm('Reset all activities?')) return;
        
        Object.values(this.intervals).forEach(clearInterval);
        this.intervals = {};
        this.activities = [];
        this.finishedActivities = [];
        this.saveData();
        this.render();
      }

      formatTime(seconds) {
        const hrs = Math.floor(seconds / 3600);
        const mins = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        return `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
      }

      formatDateTime(isoString) {
        if (!isoString) return 'N/A';
        const date = new Date(isoString);
        return date.toLocaleString('en-US', {
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      }

      getTotalTime() {
        return this.activities.reduce((sum, a) => sum + a.elapsed, 0);
      }

      getAllTotal() {
        return [...this.activities, ...this.finishedActivities].reduce((sum, a) => sum + a.elapsed, 0);
      }

      render() {
        const COLORS = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16'];
        
        document.getElementById('root').innerHTML = `
          <div class="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 p-4 md:p-8">
            <div class="max-w-6xl mx-auto">
              
              <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-white mb-2">Activity Time Tracker</h1>
                <p class="text-slate-400">Track multiple activities simultaneously</p>
              </div>

              <div class="flex justify-center gap-2 mb-6">
                <button onclick="app.view='tracker'; app.render()" 
                  class="px-6 py-2 rounded-lg font-medium transition-all ${this.view === 'tracker' ? 'bg-blue-600 text-white' : 'bg-slate-700 text-slate-300'}">
                  Tracker
                </button>
                <button onclick="app.view='reports'; app.render()" 
                  class="px-6 py-2 rounded-lg font-medium transition-all ${this.view === 'reports' ? 'bg-blue-600 text-white' : 'bg-slate-700 text-slate-300'}">
                  Reports
                </button>
              </div>

              ${this.view === 'tracker' ? this.renderTracker(COLORS) : this.renderReports(COLORS)}
            </div>
          </div>
        `;

        this.attachEventListeners();
      }

      renderTracker(COLORS) {
        return `
          <div class="space-y-6">
            <div class="bg-slate-800 rounded-xl p-6 shadow-xl border border-slate-700">
              <div class="flex gap-2">
                <input type="text" id="newActivityInput" placeholder="Enter activity name..."
                  class="flex-1 px-4 py-3 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button onclick="app.addActivity(document.getElementById('newActivityInput').value); document.getElementById('newActivityInput').value=''"
                  class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium">
                  Add
                </button>
              </div>
            </div>

            ${this.activities.length > 0 ? `
              <div>
                <h2 class="text-xl font-bold text-white mb-3">Active Activities</h2>
                <div class="space-y-3">
                  ${this.activities.map((activity, idx) => `
                    <div class="bg-slate-800 rounded-xl p-6 shadow-xl border border-slate-700">
                      <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4 flex-1">
                          <div class="w-3 h-3 rounded-full" style="background: ${COLORS[idx % COLORS.length]}"></div>
                          <div class="flex-1">
                            <h3 class="text-lg font-semibold text-white">${activity.name}</h3>
                            <p class="text-3xl font-mono font-bold text-blue-400 mt-1">${this.formatTime(activity.elapsed)}</p>
                          </div>
                        </div>
                        <div class="flex items-center gap-2">
                          <button onclick="app.toggleActivity(${activity.id})"
                            class="p-3 rounded-lg transition-all ${activity.isRunning ? 'bg-orange-600 hover:bg-orange-700' : 'bg-green-600 hover:bg-green-700'} text-white">
                            ${activity.isRunning ? '‚è∏' : '‚ñ∂'}
                          </button>
                          <button onclick="app.finishActivity(${activity.id})"
                            class="p-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                            ‚úì
                          </button>
                          <button onclick="app.deleteActivity(${activity.id})"
                            class="p-3 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors">
                            üóë
                          </button>
                        </div>
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>

              ${this.showTotalTimer ? `
                <div class="bg-gradient-to-r from-blue-600 to-purple-600 rounded-xl p-6 shadow-xl">
                  <div class="flex items-center justify-between">
                    <h3 class="text-xl font-semibold text-white">Total Active Time</h3>
                    <p class="text-4xl font-mono font-bold text-white">${this.formatTime(this.getTotalTime())}</p>
                  </div>
                </div>
              ` : ''}
            ` : ''}

            ${this.finishedActivities.length > 0 ? `
              <div>
                <h2 class="text-xl font-bold text-white mb-3">Finished Activities</h2>
                <div class="space-y-3">
                  ${this.finishedActivities.map((activity, idx) => `
                    <div class="bg-slate-800 rounded-xl p-6 shadow-xl border border-slate-700 opacity-90">
                      <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4 flex-1">
                          <div class="w-3 h-3 rounded-full" style="background: ${COLORS[(this.activities.length + idx) % COLORS.length]}"></div>
                          <div class="flex-1">
                            <div class="flex items-center gap-2">
                              <h3 class="text-lg font-semibold text-white">${activity.name}</h3>
                              <span class="px-2 py-1 bg-green-600/20 text-green-400 text-xs rounded-full">Completed</span>
                            </div>
                            <p class="text-2xl font-mono font-bold text-slate-300 mt-1">${this.formatTime(activity.elapsed)}</p>
                            <p class="text-sm text-slate-400 mt-1">${this.formatDateTime(activity.startTime)} - ${this.formatDateTime(activity.endTime)}</p>
                          </div>
                        </div>
                        <button onclick="app.deleteFinished(${activity.id})"
                          class="p-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors">
                          üóë
                        </button>
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>
            ` : ''}

            ${this.activities.length === 0 && this.finishedActivities.length === 0 ? `
              <div class="bg-slate-800 rounded-xl p-12 text-center border border-slate-700">
                <p class="text-slate-400 text-lg">No activities yet. Add one to get started!</p>
              </div>
            ` : ''}

            ${this.activities.length > 0 || this.finishedActivities.length > 0 ? `
              <button onclick="app.resetAll()"
                class="w-full px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors font-medium">
                Reset All Activities
              </button>
            ` : ''}
          </div>
        `;
      }

      renderReports(COLORS) {
        const allActivities = [...this.activities, ...this.finishedActivities].filter(a => a.elapsed > 0);
        const total = this.getAllTotal();

        return `
          <div class="space-y-6">
            ${allActivities.length > 0 ? `
              <div class="bg-slate-800 rounded-xl p-6 shadow-xl border border-slate-700">
                <div class="overflow-x-auto">
                  <table class="w-full text-left">
                    <thead>
                      <tr class="border-b border-slate-700">
                        <th class="py-3 px-4 text-slate-300 font-semibold">Activity</th>
                        <th class="py-3 px-4 text-slate-300 font-semibold">Status</th>
                        <th class="py-3 px-4 text-slate-300 font-semibold">Time</th>
                        <th class="py-3 px-4 text-slate-300 font-semibold">Hours</th>
                        <th class="py-3 px-4 text-slate-300 font-semibold">%</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${allActivities.map((activity, idx) => {
                        const isFinished = this.finishedActivities.some(f => f.id === activity.id);
                        return `
                          <tr class="border-b border-slate-700 hover:bg-slate-700/50">
                            <td class="py-3 px-4">
                              <div class="flex items-center gap-2">
                                <div class="w-3 h-3 rounded-full" style="background: ${COLORS[idx % COLORS.length]}"></div>
                                <span class="text-white">${activity.name}</span>
                              </div>
                            </td>
                            <td class="py-3 px-4">
                              <span class="px-2 py-1 text-xs rounded-full ${isFinished ? 'bg-green-600/20 text-green-400' : 'bg-blue-600/20 text-blue-400'}">
                                ${isFinished ? 'Completed' : 'Active'}
                              </span>
                            </td>
                            <td class="py-3 px-4 text-slate-300 font-mono">${this.formatTime(activity.elapsed)}</td>
                            <td class="py-3 px-4 text-slate-300">${(activity.elapsed / 3600).toFixed(2)}h</td>
                            <td class="py-3 px-4 text-slate-300">${((activity.elapsed / total) * 100).toFixed(1)}%</td>
                          </tr>
                        `;
                      }).join('')}
                    </tbody>
                    <tfoot>
                      <tr class="border-t-2 border-slate-600 font-semibold">
                        <td class="py-3 px-4 text-white">Total</td>
                        <td class="py-3 px-4 text-white">-</td>
                        <td class="py-3 px-4 text-white font-mono">${this.formatTime(total)}</td>
                        <td class="py-3 px-4 text-white">${(total / 3600).toFixed(2)}h</td>
                        <td class="py-3 px-4 text-white">100%</td>
                      </tr>
                    </tfoot>
                  </table>
                </div>

                <div class="mt-6 space-y-2">
                  <h3 class="text-white font-semibold mb-3">Visual Breakdown</h3>
                  ${allActivities.map((activity, idx) => {
                    const percentage = ((activity.elapsed / total) * 100).toFixed(1);
                    return `
                      <div>
                        <div class="flex justify-between text-sm text-slate-300 mb-1">
                          <span>${activity.name}</span>
                          <span>${percentage}%</span>
                        </div>
                        <div class="w-full bg-slate-700 rounded-full h-4">
                          <div class="h-4 rounded-full transition-all" 
                            style="width: ${percentage}%; background: ${COLORS[idx % COLORS.length]}">
                          </div>
                        </div>
                      </div>
                    `;
                  }).join('')}
                </div>
              </div>
            ` : `
              <div class="bg-slate-800 rounded-xl p-12 text-center border border-slate-700">
                <p class="text-slate-400 text-lg">No activity data. Start tracking!</p>
              </div>
            `}
          </div>
        `;
      }

      attachEventListeners() {
        const input = document.getElementById('newActivityInput');
        if (input) {
          input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
              this.addActivity(input.value);
              input.value = '';
            }
          });
        }
      }
    }

    // Start app
    let app;
    window.addEventListener('DOMContentLoaded', () => {
      app = new TimeTracker();
    });

    // Service Worker
    if ('serviceWorker' in navigator) {
      const isPreview = window.location.hostname.includes('claudeusercontent.com') || 
                       window.location.hostname === 'localhost';
      
      if (!isPreview) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./sw.js')
            .then(reg => console.log('SW registered'))
            .catch(err => console.log('SW failed:', err));
        });
      }
    }
  </script>
</body>
</html>
